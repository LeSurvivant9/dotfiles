{{- /* Common, OS-agnostic setup first */ -}}

### ZINIT
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
[ ! -d $ZINIT_HOME ] && mkdir -p "$(dirname $ZINIT_HOME)"
[ ! -d $ZINIT_HOME/.git ] && git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
source "${ZINIT_HOME}/zinit.zsh"
###

# NVM (auto-switch via plugin)
export NVM_AUTO_USE=true

# General editor settings
if command -v brew >/dev/null 2>&1; then
  BREW_PREFIX="$(brew --prefix 2>/dev/null)"
  if [ -n "$BREW_PREFIX" ] && [ -d "$BREW_PREFIX" ]; then
    if [ -d "$BREW_PREFIX/bin" ]; then
      export PATH="$BREW_PREFIX/bin:$PATH"
    fi
    if [ -d "$BREW_PREFIX/sbin" ]; then
      export PATH="$BREW_PREFIX/sbin:$PATH"
    fi
    # Prefer Homebrew neovim if present
    if [ -x "$BREW_PREFIX/bin/nvim" ]; then
      NVIM_BIN="$BREW_PREFIX/bin/nvim"
    fi
  fi
fi

if [ -z "$NVIM_BIN" ]; then
  for p in /opt/homebrew/bin/nvim /usr/local/bin/nvim; do
    if [ -x "$p" ]; then NVIM_BIN="$p"; break; fi
  done
fi

if [ -n "$NVIM_BIN" ]; then
  export EDITOR="$NVIM_BIN"
  export VISUAL="$NVIM_BIN"
  export SUDO_EDITOR="$NVIM_BIN"
  alias vim="$NVIM_BIN"
else
  export EDITOR='nvim'
  export VISUAL='nvim'
  export SUDO_EDITOR='nvim'
  alias vim='nvim'
fi

# Core plugins (cross-platform)
zinit light zsh-users/zsh-syntax-highlighting
zinit light zsh-users/zsh-completions
zinit light zsh-users/zsh-autosuggestions
zinit light Aloxaf/fzf-tab
{{- if not ((stat (joinPath .chezmoi.homeDir ".atuin/bin")).isDir) }}
  zinit load atuinsh/atuin
{{- end }}

# OMZ snippets that are generally portable
zinit snippet OMZP::bun
zinit snippet OMZP::colorize
zinit snippet OMZP::common-aliases
zinit snippet OMZP::composer
zinit snippet OMZP::copypath
zinit snippet OMZP::docker
zinit snippet OMZP::docker-compose
zinit snippet OMZP::dotenv
zinit snippet OMZP::fzf
zinit snippet OMZL::git.zsh
zinit snippet OMZP::git
zinit snippet OMZP::nvm
zinit snippet OMZP::postgres
zinit snippet OMZP::python
zinit snippet OMZP::safe-paste
zinit snippet OMZP::ssh
zinit snippet OMZP::symfony

# Keybindings
bindkey '^p' history-search-backward
bindkey '^n' history-search-forward

# Load completions
fpath=(~/.zsh/completion $fpath)
autoload -U compinit && compinit

zinit cdreplay -q

# History
HISTSIZE=5000
HISTFILE=~/.zsh_history
SAVEHIST=$HISTSIZE
HISTDUP=erase
setopt appendhistory
setopt sharehistory
setopt hist_ignore_space
setopt hist_ignore_all_dups
setopt hist_save_no_dups
setopt hist_ignore_dups
setopt hist_find_no_dups

# Completion styling
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
zstyle ':completion:*' menu no
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'ls --color $realpath'

# Generic aliases
alias c='clear'
alias se='sudo nvim'
alias sudo='sudo -E '
alias ubun-attach="sudo lxc-attach -n ubun --clear-env -v TERM=xterm-256color -u 1001"
# b => bat
{{- if lookPath "bat" }}
alias b='bat'
{{- else }}
  # bat non installé: installez-le avec Homebrew (brew install bat)
  # On ne stoppe pas le chargement du shell; l'alias ne sera pas défini.
{{- end }}
# l => eza listing (prefer eza if available)
{{- if lookPath "eza" }}
lc() {
local total=$(eza -1a "$@" | wc -l | xargs)
local dirs=$(eza -1A --only-dirs "$@" 2>/dev/null | wc -l | xargs)
local files=$(eza -1a --only-files "$@" 2>/dev/null | wc -l | xargs)
print -P "%B$total%b éléments (%F{green}$dirs%f dossiers, %F{yellow}$files%f fichiers)\n"

eza -l -F -h -a --group-directories-first --icons=auto "$@"
}
alias l='lc'
{{- else }}
alias l='ls -lFha'
{{- end }}

# Shell integrations
eval "$(starship init zsh)"

# Language/tool shims
# Bun (local install)
if [ -d "${BUN_INSTALL:-$HOME/.bun}/bin" ]; then
  export PATH="${BUN_INSTALL:-$HOME/.bun}/bin:$PATH"
fi

# Bun: complétions (si le fichier existe)
if [ -s "${BUN_INSTALL:-$HOME/.bun}/_bun" ]; then
  source "${BUN_INSTALL:-$HOME/.bun}/_bun"
fi

# Atuin standalone install (curl) bootstrap
if [ -d "$HOME/.atuin/bin" ]; then
  export PATH="$HOME/.atuin/bin:$PATH"
  [ -f "$HOME/.atuin/bin/env" ] && source "$HOME/.atuin/bin/env"
fi

# uv (Astral) standalone install
if [ -d "$HOME/.local/bin" ]; then
  export PATH="$HOME/.local/bin:$PATH"
  [ -f "$HOME/.local/bin/env" ] && source "$HOME/.local/bin/env"
fi

# Atuin (if present)
{{- if lookPath "atuin" }}
  eval "$(atuin init zsh)"
{{- end }}

# Symfony CLI completion (if present)
{{- if lookPath "symfony" }}
  [[ -f "$HOME/.symfony_completion" ]] || symfony completion zsh > "$HOME/.symfony_completion"
  source "$HOME/.symfony_completion"
{{- end }}

# ngrok: complétions (si présent)
{{- if lookPath "ngrok" }}
  eval "$(ngrok completion)"
{{- end }}

# Cargo (if present)
{{- if lookPath "cargo" }}
  export PATH="$HOME/.cargo/bin:$PATH"
  [[ -f "$HOME/.cargo/env" ]] && source "$HOME/.cargo/env"
{{- end }}

# ---------------- Outils Dockerisés ----------------
{{- if lookPath "docker" }}
  beet() {
    docker exec -u 1000:1000 -i beets beet "$@"
  }
{{- end }}

# fzf keybindings & completion (paths vary by OS/distro)
{{- $os := .chezmoi.os -}}
{{- $rel := .chezmoi.osRelease -}}
{{- $id := default "" (index $rel "ID") -}}
{{- $like := default "" (index $rel "ID_LIKE") -}}
{{- $isArch := and (eq $os "linux") (eq $id "arch") -}}
{{- $isDebianLike := and (eq $os "linux") (or (eq $id "debian") (contains "debian" $like)) -}}
{{- $isUbuntu := and (eq $os "linux") (or (eq $id "ubuntu") (contains "ubuntu" $like)) -}}
{{- $isRaspbian := and (eq $os "linux") (or (eq $id "raspbian") (contains "raspbian" $like)) -}}

{{- if lookPath "fzf" }}
  {{- if eq $os "darwin" }}
    # Homebrew installs
    {{- if lookPath "brew" }}
      FZF_PREFIX="$(brew --prefix)/opt/fzf"
      [ -f "$FZF_PREFIX/shell/key-bindings.zsh" ] && source "$FZF_PREFIX/shell/key-bindings.zsh"
      [ -f "$FZF_PREFIX/shell/completion.zsh" ] && source "$FZF_PREFIX/shell/completion.zsh"
    {{- end }}
  {{- else if $isArch }}
      [ -f /usr/share/fzf/key-bindings.zsh ] && source /usr/share/fzf/key-bindings.zsh
      [ -f /usr/share/fzf/completion.zsh ]   && source /usr/share/fzf/completion.zsh
  {{- else }}
      # Debian/Ubuntu/Raspbian often ship examples here
      [ -f /usr/share/doc/fzf/examples/key-bindings.zsh ] && source /usr/share/doc/fzf/examples/key-bindings.zsh
      [ -f /usr/share/doc/fzf/examples/completion.zsh ]   && source /usr/share/doc/fzf/examples/completion.zsh
  {{- end }}
{{- end }}

# ---------------- OS/Distro specific blocks ----------------

{{- if eq $os "darwin" }}
  # LLVM from Homebrew (if installed)
  export PATH="/opt/homebrew/opt/llvm/bin:$PATH"

  # JAVA_HOME (si java_home 21 est disponible)
  if command -v /usr/libexec/java_home >/dev/null 2>&1; then
    JAVA_21="$([ -x /usr/libexec/java_home ] && /usr/libexec/java_home -v 21 2>/dev/null)"
    [ -n "$JAVA_21" ] && export JAVA_HOME="$JAVA_21"
  fi

  # Bitwarden SSH agent socket (macOS)
  # Prefer the .dmg install socket, fall back to Mac App Store container path.
  if [ -S "$HOME/.bitwarden-ssh-agent.sock" ]; then
    export SSH_AUTH_SOCK="$HOME/.bitwarden-ssh-agent.sock"
  elif [ -S "$HOME/Library/Containers/com.bitwarden.desktop/Data/.bitwarden-ssh-agent.sock" ]; then
    export SSH_AUTH_SOCK="$HOME/Library/Containers/com.bitwarden.desktop/Data/.bitwarden-ssh-agent.sock"
  fi
  # Also export SSH_AUTH_SOCKET for compatibility with launchctl-based setups
  [ -n "$SSH_AUTH_SOCK" ] && export SSH_AUTH_SOCKET="$SSH_AUTH_SOCK"

  # command-not-found equivalent via Homebrew (official handler)
  {{- if lookPath "brew" }}
    HOMEBREW_COMMAND_NOT_FOUND_HANDLER="$(brew --repository)/Library/Homebrew/command-not-found/handler.sh"
    if [ -f "$HOMEBREW_COMMAND_NOT_FOUND_HANDLER" ]; then
      source "$HOMEBREW_COMMAND_NOT_FOUND_HANDLER";
    fi
  {{- end }}
{{- end }}

{{- if eq $os "linux" }}
  # Linux generic settings valid for Arch, Ubuntu (WSL), Raspbian

  # Linuxbrew (if present)
  if [ -d "/home/linuxbrew/.linuxbrew/bin" ]; then
      export PATH="/home/linuxbrew/.linuxbrew/bin:$PATH"
      export MANPATH="/home/linuxbrew/.linuxbrew/share/man:$MANPATH"
      export INFOPATH="/home/linuxbrew/.linuxbrew/share/info:$INFOPATH"
  fi

  # Bitwarden SSH agent socket (Linux)
  if [ -S "$HOME/.bitwarden-ssh-agent.sock" ]; then
    export SSH_AUTH_SOCK="$HOME/.bitwarden-ssh-agent.sock"
  fi

  # Command-not-found handler
  {{- if $isArch }}
    # Arch Linux: use pkgfile's handler (requires: sudo pacman -S pkgfile; then `pkgfile -u`)
    if [ -f /usr/share/doc/pkgfile/command-not-found.zsh ]; then
      source /usr/share/doc/pkgfile/command-not-found.zsh
    else
      # Fallback to OMZ plugin if pkgfile handler not found
      zinit snippet OMZP::command-not-found
    fi
  {{- else }}
    # Non-Arch Linux: use OMZ plugin
    zinit snippet OMZP::command-not-found
  {{- end }}

  # WSL-specific tweaks (runtime detection; covers Ubuntu via WSL)
  if grep -qi microsoft /proc/sys/kernel/osrelease 2>/dev/null; then
    command -v clip.exe >/dev/null 2>&1 && alias clip='clip.exe'
    [ -z "$DISPLAY" ] && export DISPLAY="$(grep -m 1 nameserver /etc/resolv.conf | awk '{print $2}')":0
  fi

  # Distro-specific hooks (placeholders for future needs)
  {{- if $isArch }}
    # Arch-specific adjustments can go here
  {{- end }}
  {{- if $isUbuntu }}
    # Ubuntu-specific adjustments can go here
  {{- end }}
  {{- if $isRaspbian }}
    # Raspbian-specific adjustments can go here
  {{- end }}
{{- end }}
